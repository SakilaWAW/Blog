# Grafana 调研

## 是什么?

Grafana 是由`Grafana Labs公司开源`的一个`系统监测 (System Monitoring) 工具`。它可以大大帮助你`简化监控的复杂度`，你只需要提供你需要监控的数据，它就可以帮你`生成各种可视化仪表`。同时它还有`报警功能`，可以在系统出现问题时通知你。Grafana 不对数据源作假设，支持多种数据库。

## 什么时候用？

埋点+监控埋点数据来检测数据问题，只要用到仪表盘就可以用 grafana。

## 工作原理？

![工作原理](https://kalasearch.cn/static/e73f320abbd4d852c468f6ceadc67c9a/46e51/grafana-relationship.png)

类似 ELK，Prometheus(也可以是其他数据库)用来存储和聚合数据，Loki 进行 log 类似 Logstash，grafana 进行前端 UI 配置和展现。

## 特色

1. 开箱即用， 只需要简单的配置，就可以得到一个美观的 Dashboard
2. 配套库已成体系，grafana+多种可选数据库+Loki 搭配，满足看板的基础需求
3. 丰富的插件系统，满足基本功能以外的需求
4. 自带用户管理体系，可以以各种粒度：有关用户的 User(用户)、Team(一组用户)，有关看板的 dashboard(看板)、folder(一组看板)和权限本身的 Admin、Edit、View，任意组合
5. 支持 Alert 报警，可以通过 WebHook 进行报警反馈

## 二次开发可以做什么？

可以通过 Plugins 的方式进行二次开发，使用 ts 进行开发，三种插件类型：

### 1. panels

提供新的仪表

### 2. data sources

适配新的数据源

### 3. apps

自定义一套图表和数据源的组合，是前两者的结合，比如[Kubernetes](https://grafana.com/grafana/plugins/grafana-kubernetes-app)是针对 k8s 定制的一套展示)

## 和知识库结合后的问题点分析

这节列举我能想到的问题和调研后的解决方案

### 1. 如何嵌入知识库系统

通过 iframe 的方式，具体可以参照[这篇文章](https://thenishchalraj.medium.com/dynamically-embed-grafana-dashboards-in-a-react-component-483b9ecd1dcd)

### 2. 权限如何接入

我在官方文档虽然看到可以通过 OAuth 进行第三方认证登录，但是没有看到通过第三方权限系统控制图表展示的功能。

说的更细点，Grafana自身包含一套权限管理体系(我们设其为规则A)，grafana源码使用这个A对所有图表进行展示的判断。我们当前的知识库也有一套权限管理体系(我们设其为规则B)，规则B和规则A不同，如果我们想要统一使用B进行权限管理(权限不可能有两个地方配置)，必然要修改 A→组件展示 这段逻辑，而Grafana没有对外提供这样一个修改逻辑的地方。这意味着我们要去阅读源码并且进行修改，这个过程是有时间成本的。

综上：个人认为Grafana自带的权限体系很难和我们知识库系统的现有权限体系(一个权限对应一个图表)做兼容，需要修改 Grafana 源码，时间成本较高，反而不如使用传统的 Echarts 来编码来的快。

### 3. 是否可以自定义表格

可以，grafana 官方提供大量 Panel 插件，实在没有也可以自己实现 Panels Plugin

## 使用/不使用 Grafana 的工作量对比

|                         | Grafana | 传统模式 |
| :---------------------: | :-----: | :------: |
|      后台数据存储       |    √    |    √     |
|      后台统计接口       |    ×    |    √     |
| 后台 SQL 聚合(查询)语句 |    √    |    √     |
|      前端图表开发       |    ×    |    √     |
|    前端页面逻辑开发     |    ×    |    √     |
|      前端页面配置       |    √    |    ×     |
|        前端埋点         |    √    |    √     |

对后端来说：使用Grafana可以少写一些接口逻辑

对前端来说：使用Grafana可以让图表从开发变为配置

另外使用Grafana可以让程序扩展性强很多

## 总结

Grafana 是一套非常成熟并且高效的仪表盘框架，提供了大量开箱即用的功能，功能完备，UI 美观，可扩展性强。但是由于 Grafana 和知识库的权限系统很难兼容，本次需求不推荐使用，之后如果有合适的需求，非常推荐使用。

> 结论用一句话概括: Grafana 非常优秀，但是更适合从无到有的系统快速搭建，很难兼容当前知识库的权限逻辑。
